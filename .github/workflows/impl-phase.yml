name: Impl Phase - å®Ÿè£…

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  start-impl-phase:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.head.ref, '/plan')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: bun install

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps
        working-directory: apps/web

      - name: Extract feature info from branch
        id: extract
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          FEATURE_PREFIX=$(echo "$BRANCH" | sed 's|/plan$||')
          echo "feature_prefix=$FEATURE_PREFIX" >> $GITHUB_OUTPUT
          echo "impl_branch=${FEATURE_PREFIX}/impl" >> $GITHUB_OUTPUT

      - name: Find parent issue
        id: find-parent
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body;
            const match = prBody.match(/è¦ªIssue: #(\d+)/);
            if (match) {
              core.setOutput('parent_issue', match[1]);
            } else {
              core.setFailed('Could not find parent issue reference');
            }

      - name: Create impl sub-issue
        id: create-sub-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: subIssue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Impl] ${context.payload.pull_request.title.replace('[Plan] ', '')}`,
              body: `## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º\n\nè¦ªIssue: #${{ steps.find-parent.outputs.parent_issue }}\n\n### è‡ªå‹•å®Ÿè¡Œå†…å®¹\n- [ ] /implement å®Ÿè¡Œ\n- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- [ ] E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- [ ] PRä½œæˆ\n\n### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\nğŸ”„ å‡¦ç†ä¸­...`,
              labels: ['phase:impl', 'status:in-progress']
            });

            core.setOutput('sub_issue_number', subIssue.number);
            return subIssue.number;

      - name: Create impl branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.extract.outputs.impl_branch }}
          git push -u origin ${{ steps.extract.outputs.impl_branch }}

      - name: Run spec-kit implement
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat << 'EOF' > /tmp/impl-prompt.txt
          ã“ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

          ## æŒ‡ç¤º
          1. /implement ã‚’å®Ÿè¡Œã—ã¦ã‚¿ã‚¹ã‚¯ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„
          2. å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„
          EOF

          claude --print -p "$(cat /tmp/impl-prompt.txt)" || echo "Claude execution completed"

      - name: Commit implementation
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: æ©Ÿèƒ½å®Ÿè£…

          Refs #${{ steps.find-parent.outputs.parent_issue }}

          Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi

      - name: Run unit tests
        id: unit-tests
        run: |
          bun run test || echo "unit_test_failed=true" >> $GITHUB_OUTPUT
        working-directory: apps/web
        continue-on-error: true

      - name: Run E2E tests
        id: e2e-tests
        run: |
          bun run build
          bun run test:e2e || echo "e2e_test_failed=true" >> $GITHUB_OUTPUT
        working-directory: apps/web
        continue-on-error: true

      - name: Check test results
        id: test-results
        run: |
          if [[ "${{ steps.unit-tests.outputs.unit_test_failed }}" == "true" ]] || [[ "${{ steps.e2e-tests.outputs.e2e_test_failed }}" == "true" ]]; then
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.test-results.outputs.tests_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Impl] ${context.payload.pull_request.title.replace('[Plan] ', '')}`,
              head: '${{ steps.extract.outputs.impl_branch }}',
              base: 'main',
              body: `## å®Ÿè£… PR\n\n### é–¢é€£Issue\n- è¦ªIssue: #${{ steps.find-parent.outputs.parent_issue }}\n- å®Ÿè£…Issue: #${{ steps.create-sub-issue.outputs.sub_issue_number }}\n\n### å¤‰æ›´å†…å®¹\n- æ©Ÿèƒ½ã®å®Ÿè£…\n\n### ãƒ†ã‚¹ãƒˆçµæœ\n- âœ… å˜ä½“ãƒ†ã‚¹ãƒˆ: ãƒ‘ã‚¹\n- âœ… E2Eãƒ†ã‚¹ãƒˆ: ãƒ‘ã‚¹\n\n---\nğŸ¤– Generated by spec-kit automation`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-sub-issue.outputs.sub_issue_number }},
              body: `## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º\n\nè¦ªIssue: #${{ steps.find-parent.outputs.parent_issue }}\nPR: #${pr.number}\n\n### è‡ªå‹•å®Ÿè¡Œå†…å®¹\n- [x] /implement å®Ÿè¡Œ\n- [x] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- [x] E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- [x] PRä½œæˆ\n\n### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\nâœ… PRä½œæˆå®Œäº† - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡`
            });

      - name: Update sub-issue on test failure
        if: steps.test-results.outputs.tests_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-sub-issue.outputs.sub_issue_number }},
              body: `## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º\n\nè¦ªIssue: #${{ steps.find-parent.outputs.parent_issue }}\n\n### è‡ªå‹•å®Ÿè¡Œå†…å®¹\n- [x] /implement å®Ÿè¡Œ\n- [x] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- [x] E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- [ ] PRä½œæˆ\n\n### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\nâŒ ãƒ†ã‚¹ãƒˆå¤±æ•— - æ‰‹å‹•å¯¾å¿œãŒå¿…è¦ã§ã™\n\n### è©³ç´°\nWorkflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['phase:impl', 'status:blocked']
            });

      - name: Update parent issue on success
        if: steps.test-results.outputs.tests_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find-parent.outputs.parent_issue }},
              labels: ['status:impl-review']
            });
