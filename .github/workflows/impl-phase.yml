name: Impl Phase - å®Ÿè£…

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  setup-impl-phase:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.head.ref, '/plan')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract feature info from branch
        id: extract
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          FEATURE_PREFIX=$(echo "$BRANCH" | sed 's|/plan$||')
          FEATURE_NAME=$(echo "$FEATURE_PREFIX" | sed 's|^[0-9]*-||')

          echo "feature_prefix=$FEATURE_PREFIX" >> $GITHUB_OUTPUT
          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
          echo "impl_branch=${FEATURE_PREFIX}/impl" >> $GITHUB_OUTPUT

      - name: Find parent issue
        id: find-parent
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body;
            const match = prBody.match(/è¦ªIssue: #(\d+)/);
            if (match) {
              core.setOutput('parent_issue', match[1]);
            } else {
              core.setOutput('parent_issue', '');
            }

      - name: Create impl branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.extract.outputs.impl_branch }}

          # Create placeholder
          mkdir -p specs/${{ steps.extract.outputs.feature_prefix }}
          touch specs/${{ steps.extract.outputs.feature_prefix }}/.impl-phase

          git add .
          git commit -m "chore: å®Ÿè£…ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ" --allow-empty
          git push -u origin ${{ steps.extract.outputs.impl_branch }}

      - name: Create impl sub-issue with instructions
        id: create-sub-issue
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.extract.outputs.impl_branch }}';
            const featureName = '${{ steps.extract.outputs.feature_name }}';
            const parentIssue = '${{ steps.find-parent.outputs.parent_issue }}';

            const instructions = `## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

            è¦ªIssue: #${parentIssue}
            ãƒ–ãƒ©ãƒ³ãƒ: \`${branchName}\`

            ### å®Ÿè¡Œæ‰‹é †

            #### 1. ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            \`\`\`bash
            git fetch origin
            git checkout ${branchName}
            \`\`\`

            #### 2. spec-kit ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
            Claude Code ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
            \`\`\`
            /implement
            \`\`\`

            #### 3. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            \`\`\`bash
            bun run test
            bun run test:e2e
            \`\`\`

            #### 4. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
            \`\`\`bash
            git add .
            git commit -m "feat: æ©Ÿèƒ½ã‚’å®Ÿè£…"
            git push
            \`\`\`

            #### 5. PRã‚’ä½œæˆ
            ãƒ—ãƒƒã‚·ãƒ¥å¾Œã€è‡ªå‹•çš„ã«PRãŒä½œæˆã•ã‚Œã¾ã™ã€‚

            ---
            ### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            â³ æ‰‹å‹•å®Ÿè¡Œå¾…ã¡`;

            const { data: subIssue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Impl] ${featureName}`,
              body: instructions,
              labels: ['phase:impl', 'status:in-progress']
            });

            core.setOutput('sub_issue_number', subIssue.number);

      - name: Comment on parent issue
        if: steps.find-parent.outputs.parent_issue != ''
        uses: actions/github-script@v7
        with:
          script: |
            const parentIssue = ${{ steps.find-parent.outputs.parent_issue }};
            const subIssue = ${{ steps.create-sub-issue.outputs.sub_issue_number }};
            const branchName = '${{ steps.extract.outputs.impl_branch }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssue,
              body: `## ğŸ› ï¸ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹ã—ã¾ã—ãŸ

            - Sub-issue: #${subIssue}
            - ãƒ–ãƒ©ãƒ³ãƒ: \`${branchName}\`

            è©³ç´°ãªæ‰‹é †ã¯ Sub-issue ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
            });
