name: Create PR on Push

on:
  push:
    branches:
      - '*/spec'
      - '*/plan'
      - '*/impl'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.length > 0) {
              console.log(`PR already exists: #${prs[0].number}`);
              core.setOutput('pr_exists', 'true');
              core.setOutput('pr_number', prs[0].number);
            } else {
              core.setOutput('pr_exists', 'false');
            }

      - name: Extract info from branch name
        if: steps.check-pr.outputs.pr_exists == 'false'
        id: extract
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # Extract phase (spec, plan, impl)
          PHASE=$(echo "$BRANCH" | sed 's|.*/||')
          echo "phase=$PHASE" >> $GITHUB_OUTPUT

          # Extract feature prefix
          FEATURE_PREFIX=$(echo "$BRANCH" | sed 's|/[^/]*$||')
          echo "feature_prefix=$FEATURE_PREFIX" >> $GITHUB_OUTPUT

          # Set PR title prefix based on phase
          case $PHASE in
            spec) echo "pr_prefix=[Spec]" >> $GITHUB_OUTPUT ;;
            plan) echo "pr_prefix=[Plan]" >> $GITHUB_OUTPUT ;;
            impl) echo "pr_prefix=[Impl]" >> $GITHUB_OUTPUT ;;
          esac

      - name: Find parent issue
        if: steps.check-pr.outputs.pr_exists == 'false'
        id: find-parent
        uses: actions/github-script@v7
        with:
          script: |
            const featurePrefix = '${{ steps.extract.outputs.feature_prefix }}';

            // Search for backlog issue mentioning this feature
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'phase:backlog',
              per_page: 100
            });

            // Find sub-issue for this phase
            const phase = '${{ steps.extract.outputs.phase }}';
            const { data: subIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: `phase:${phase}`,
              per_page: 100
            });

            // Find sub-issue that mentions this branch
            const branch = '${{ steps.extract.outputs.branch }}';
            let subIssue = null;
            for (const issue of subIssues) {
              if (issue.body && issue.body.includes(branch)) {
                subIssue = issue;
                break;
              }
            }

            if (subIssue) {
              core.setOutput('sub_issue_number', subIssue.number);

              // Extract parent issue from sub-issue body
              const parentMatch = subIssue.body.match(/è¦ªIssue: #(\d+)/);
              if (parentMatch) {
                core.setOutput('parent_issue', parentMatch[1]);
              }
            }

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.extract.outputs.branch }}';
            const phase = '${{ steps.extract.outputs.phase }}';
            const prPrefix = '${{ steps.extract.outputs.pr_prefix }}';
            const featurePrefix = '${{ steps.extract.outputs.feature_prefix }}';
            const parentIssue = '${{ steps.find-parent.outputs.parent_issue }}' || 'N/A';
            const subIssue = '${{ steps.find-parent.outputs.sub_issue_number }}' || 'N/A';

            // Get feature name from branch
            const featureName = featurePrefix.replace(/^\d{3}-/, '');

            let nextStep = '';
            switch (phase) {
              case 'spec':
                nextStep = 'ã“ã®PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¨ã€å®Ÿè£…è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚';
                break;
              case 'plan':
                nextStep = 'ã“ã®PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¨ã€å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚';
                break;
              case 'impl':
                nextStep = 'ã“ã®PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¨ã€æ©Ÿèƒ½ãŒå®Œäº†ã—ã¾ã™ã€‚';
                break;
            }

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${prPrefix} ${featureName}`,
              head: branch,
              base: 'main',
              body: `## ${prPrefix} PR

            ### é–¢é€£Issue
            - è¦ªIssue: #${parentIssue}
            - ãƒ•ã‚§ãƒ¼ã‚ºIssue: #${subIssue}

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            ${nextStep}

            ---
            ğŸ¤– Generated by automation workflow`
            });

            console.log(`Created PR #${pr.number}`);

            // Update sub-issue if found
            if (subIssue !== 'N/A') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(subIssue),
                body: `## âœ… PRä½œæˆå®Œäº†\n\nPR: #${pr.number}\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
              });
            }
