name: Complete Phase - å®Œäº†å‡¦ç†

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  complete-feature:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.head.ref, '/impl')
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Find parent issue
        id: find-parent
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body;
            const match = prBody.match(/è¦ªIssue: #(\d+)/);
            if (match) {
              core.setOutput('parent_issue', match[1]);
            }

      - name: Close related issues
        uses: actions/github-script@v7
        with:
          script: |
            const parentIssue = '${{ steps.find-parent.outputs.parent_issue }}';
            if (!parentIssue) return;

            // Get all issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Find sub-issues that reference this parent
            for (const issue of issues) {
              if (issue.body && issue.body.includes(`è¦ªIssue: #${parentIssue}`)) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed'
                });
                console.log(`Closed sub-issue #${issue.number}`);
              }
            }

            // Close parent issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(parentIssue),
              state: 'closed',
              state_reason: 'completed',
              labels: ['status:done']
            });
            console.log(`Closed parent issue #${parentIssue}`);

      - name: Add completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const parentIssue = '${{ steps.find-parent.outputs.parent_issue }}';
            if (!parentIssue) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(parentIssue),
              body: `## ğŸ‰ æ©Ÿèƒ½å®Ÿè£…å®Œäº†\n\nå®Ÿè£…PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã€ã“ã®æ©Ÿèƒ½ã®é–‹ç™ºãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n### å®Ÿè¡Œã•ã‚ŒãŸãƒ•ã‚§ãƒ¼ã‚º\n- âœ… ä»•æ§˜æ¤œè¨\n- âœ… å®Ÿè£…è¨ˆç”»\n- âœ… å®Ÿè£…\n- âœ… ãƒ†ã‚¹ãƒˆ\n\n---\nğŸ¤– Automated by spec-kit workflow`
            });
