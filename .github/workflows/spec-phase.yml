name: Spec Phase - ä»•æ§˜æ¤œè¨

on:
  issues:
    types: [labeled]

jobs:
  start-spec-phase:
    if: github.event.label.name == 'phase:backlog'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract feature info
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.replace('[Backlog] ', '').trim();
            const body = issue.body;

            // Generate feature name (kebab-case)
            const featureName = title
              .toLowerCase()
              .replace(/[^a-z0-9\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf]+/g, '-')
              .replace(/^-|-$/g, '')
              .substring(0, 50);

            // Find next feature number
            const { data: branches } = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            let maxNum = 0;
            branches.forEach(branch => {
              const match = branch.name.match(/^(\d{3})-/);
              if (match) {
                maxNum = Math.max(maxNum, parseInt(match[1]));
              }
            });

            const featureNum = String(maxNum + 1).padStart(3, '0');
            const branchName = `${featureNum}-${featureName}`;

            core.setOutput('feature_num', featureNum);
            core.setOutput('feature_name', featureName);
            core.setOutput('branch_name', branchName);
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_title', title);
            core.setOutput('issue_body', body);

      - name: Create spec sub-issue
        id: create-sub-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: subIssue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Spec] ${{ steps.extract.outputs.issue_title }}`,
              body: `## ä»•æ§˜æ¤œè¨ãƒ•ã‚§ãƒ¼ã‚º\n\nè¦ªIssue: #${{ steps.extract.outputs.issue_number }}\n\n### è‡ªå‹•å®Ÿè¡Œå†…å®¹\n- [ ] /clarify å®Ÿè¡Œ\n- [ ] /specify å®Ÿè¡Œ\n- [ ] PRä½œæˆ\n\n### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\nğŸ”„ å‡¦ç†ä¸­...`,
              labels: ['phase:spec', 'status:in-progress']
            });

            core.setOutput('sub_issue_number', subIssue.number);
            core.setOutput('sub_issue_id', subIssue.id);
            return subIssue.number;

      - name: Create feature branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.extract.outputs.branch_name }}/spec
          git push -u origin ${{ steps.extract.outputs.branch_name }}/spec

      - name: Run spec-kit clarify and specify
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create prompt file
          cat << 'EOF' > /tmp/spec-prompt.txt
          ä»¥ä¸‹ã®ãƒãƒƒã‚¯ãƒ­ã‚°Issueã®ä»•æ§˜ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          ## Issueæƒ…å ±
          ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.extract.outputs.issue_title }}

          ## æœ¬æ–‡
          ${{ steps.extract.outputs.issue_body }}

          ## æŒ‡ç¤º
          1. ã¾ãš /clarify ã‚’å®Ÿè¡Œã—ã¦ä»•æ§˜ã®æ›–æ˜§ãªç‚¹ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„
          2. æ¬¡ã« /specify ã‚’å®Ÿè¡Œã—ã¦ä»•æ§˜æ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„
          3. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„
          EOF

          # Run Claude Code CLI
          claude --print -p "$(cat /tmp/spec-prompt.txt)" || echo "Claude execution completed"

      - name: Commit spec files
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs(spec): ${{ steps.extract.outputs.issue_title }}ã®ä»•æ§˜æ›¸ã‚’ä½œæˆ

          Refs #${{ steps.extract.outputs.issue_number }}

          Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Spec] ${{ steps.extract.outputs.issue_title }}`,
              head: '${{ steps.extract.outputs.branch_name }}/spec',
              base: 'main',
              body: `## ä»•æ§˜æ¤œè¨ PR\n\n### é–¢é€£Issue\n- è¦ªIssue: #${{ steps.extract.outputs.issue_number }}\n- ä»•æ§˜Issue: #${{ steps.create-sub-issue.outputs.sub_issue_number }}\n\n### å¤‰æ›´å†…å®¹\n- ä»•æ§˜æ›¸ã®ä½œæˆ\n\n### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—\nã“ã®PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¨ã€è‡ªå‹•çš„ã«å®Ÿè£…è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚ºãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚\n\n---\nğŸ¤– Generated by spec-kit automation`
            });

            // Update sub-issue with PR link
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-sub-issue.outputs.sub_issue_number }},
              body: `## ä»•æ§˜æ¤œè¨ãƒ•ã‚§ãƒ¼ã‚º\n\nè¦ªIssue: #${{ steps.extract.outputs.issue_number }}\nPR: #${pr.number}\n\n### è‡ªå‹•å®Ÿè¡Œå†…å®¹\n- [x] /clarify å®Ÿè¡Œ\n- [x] /specify å®Ÿè¡Œ\n- [x] PRä½œæˆ\n\n### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\nâœ… PRä½œæˆå®Œäº† - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡`
            });

      - name: Update parent issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.extract.outputs.issue_number }},
              labels: ['status:spec-review']
            });
