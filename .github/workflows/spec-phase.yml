name: Spec Phase - ä»•æ§˜æ¤œè¨

on:
  issues:
    types: [labeled]

jobs:
  setup-spec-phase:
    if: github.event.label.name == 'phase:backlog'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract feature info
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.replace('[Backlog] ', '').trim();
            const body = issue.body;

            // Generate feature name (kebab-case, keep Japanese)
            const featureName = title
              .replace(/[^\w\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf]+/g, '-')
              .replace(/^-|-$/g, '')
              .substring(0, 50);

            // Find next feature number
            const { data: branches } = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            let maxNum = 0;
            branches.forEach(branch => {
              const match = branch.name.match(/^(\d{3})-/);
              if (match) {
                maxNum = Math.max(maxNum, parseInt(match[1]));
              }
            });

            const featureNum = String(maxNum + 1).padStart(3, '0');
            const branchName = `${featureNum}-${featureName}`;

            core.setOutput('feature_num', featureNum);
            core.setOutput('feature_name', featureName);
            core.setOutput('branch_name', branchName);
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_title', title);

      - name: Create feature branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.extract.outputs.branch_name }}/spec

          # Create placeholder file to enable branch push
          mkdir -p specs/${{ steps.extract.outputs.branch_name }}
          echo "# ${{ steps.extract.outputs.issue_title }}" > specs/${{ steps.extract.outputs.branch_name }}/README.md
          echo "" >> specs/${{ steps.extract.outputs.branch_name }}/README.md
          echo "è¦ªIssue: #${{ steps.extract.outputs.issue_number }}" >> specs/${{ steps.extract.outputs.branch_name }}/README.md

          git add .
          git commit -m "chore: ä»•æ§˜æ¤œè¨ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ"
          git push -u origin ${{ steps.extract.outputs.branch_name }}/spec

      - name: Create spec sub-issue with instructions
        id: create-sub-issue
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.extract.outputs.branch_name }}/spec';
            const issueTitle = '${{ steps.extract.outputs.issue_title }}';
            const parentIssue = '${{ steps.extract.outputs.issue_number }}';

            const instructions = `## ä»•æ§˜æ¤œè¨ãƒ•ã‚§ãƒ¼ã‚º

            è¦ªIssue: #${parentIssue}
            ãƒ–ãƒ©ãƒ³ãƒ: \`${branchName}\`

            ### å®Ÿè¡Œæ‰‹é †

            #### 1. ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            \`\`\`bash
            git fetch origin
            git checkout ${branchName}
            \`\`\`

            #### 2. spec-kit ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
            Claude Code ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
            \`\`\`
            /clarify
            /specify "${issueTitle}"
            \`\`\`

            #### 3. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
            \`\`\`bash
            git add .
            git commit -m "docs(spec): ${issueTitle}ã®ä»•æ§˜æ›¸ã‚’ä½œæˆ"
            git push
            \`\`\`

            #### 4. PRã‚’ä½œæˆ
            ãƒ—ãƒƒã‚·ãƒ¥å¾Œã€è‡ªå‹•çš„ã«PRãŒä½œæˆã•ã‚Œã¾ã™ã€‚
            ã¾ãŸã¯æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

            ---
            ### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            â³ æ‰‹å‹•å®Ÿè¡Œå¾…ã¡`;

            const { data: subIssue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Spec] ${issueTitle}`,
              body: instructions,
              labels: ['phase:spec', 'status:in-progress']
            });

            core.setOutput('sub_issue_number', subIssue.number);

      - name: Update parent issue
        uses: actions/github-script@v7
        with:
          script: |
            const parentIssue = ${{ steps.extract.outputs.issue_number }};
            const subIssue = ${{ steps.create-sub-issue.outputs.sub_issue_number }};
            const branchName = '${{ steps.extract.outputs.branch_name }}/spec';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssue,
              body: `## ğŸš€ ä»•æ§˜æ¤œè¨ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹ã—ã¾ã—ãŸ

            - Sub-issue: #${subIssue}
            - ãƒ–ãƒ©ãƒ³ãƒ: \`${branchName}\`

            è©³ç´°ãªæ‰‹é †ã¯ Sub-issue ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
            });
